#!/bin/sh

buildClassPath() {
   jar_dir=$1
   if [ $# -ne 1 ]; then
      echo "Jar directory must be specified."
      exit 1
   fi
   class_path=
   c=1
   for i in `ls $jar_dir/*.jar`
      do
         if [ "$c" -eq "1" ]; then
            class_path=${i}
            c=2
         else
            class_path=${class_path}:${i}
      fi
   done
   echo $class_path
   }
   
   
commandline() {
   "$JAVACMD" ${JVMOPTS} "-Dcom.fatfractal.system.deploy.directory=$FATFRACTAL_HOME" "-Dcom.fatfractal.system.start.mode=cl" "-Dcom.fatfractal.tool.main=run" -jar "$JAR"
   }
   
   
start() {
   echo -n "Starting FatFractal Service: "
   cd $FATFRACTAL_HOME
   if [ -f $FATFRACTAL_PID ]; then
      PID=`cat $FATFRACTAL_PID`
      echo FatFractal Service already running: $PID                      
      exit 2;
   else
      "$JAVACMD" ${JVMOPTS} "-Dcom.fatfractal.system.deploy.directory=$FATFRACTAL_HOME" "-Dcom.fatfractal.system.start.mode=start" "-Dcom.fatfractal.tool.main=run" -jar "$JAR" 0<&- &
      PID=$!
      echo $PID > $FATFRACTAL_PID
   fi
   }

   
stop() {
   echo -n "Shutting down FatFractal Service: "
   echo
   kill -9 `cat $FATFRACTAL_PID`
   echo
   rm -f $FATFRACTAL_PID
   return 0
   }

# Lets look for Java...
cygwin=false
darwin=false
case "`uname`" in
    CYGWIN*) cygwin=true ;;
    Darwin*) darwin=true
        if [ -z "$JAVA_VERSION" ]; then
            JAVA_VERSION="CurrentJDK"
        else
            echo "Using Java version: $JAVA_VERSION"
        fi
        ;;

esac

# For Cygwin, make certain paths are UNIX style
if $cygwin ; then
    [ -n "$JAVA_HOME" ] &&
        JAVA_HOME=`cygpath --unix "$JAVA_HOME"`
fi

if [ -z "$JAVACMD" ]; then
    if [ -n "$JAVA_HOME" ]; then
        JAVACMD="$JAVA_HOME/bin/java"
    else
        JAVACMD=`which java`
    fi
fi

if [ ! -x "$JAVACMD" ]; then
   echo "ERROR: JAVA_HOME is not defined correctly. Cannot execute '$JAVACMD'."
   exit 1
fi

FATFRACTAL_HOME=`pwd`
echo "FatFractal HOME $FATFRACTAL_HOME"

if [ "$OS" = "Windows_NT" ] ; then
   PS=";"
   FATFRACTAL_HOME=`cygpath -w $FATFRACTAL_HOME`
fi

FATFRACTAL_PID=$FATFRACTAL_HOME/fatfractal.pid

cd $FATFRACTAL_HOME
#CLASSPATH=`buildClassPath lib`
JVMOPTS="-Xms512m -Xmx1024m -XX:MaxPermSize=128m -XX:+CMSClassUnloadingEnabled -XX:+UseConcMarkSweepGC -cp $CLASSPATH -Dfile.encoding=UTF-8";
if [ "$1" == "-debug" ]; then
   shift;
   JVMOPTS="-Xdebug -Xrunjdwp:transport=dt_socket,address=9999,server=y,suspend=n" ${JVMOPTS};
fi
echo $JVMOPTS

JAR=`ls lib/fatfractal-tool-*.jar`

case "$1" in
   start)
      start
      ;;
   stop)
      stop
      ;;
   cl)
      commandline
      ;;
   *)
   echo "Usage:  {start|stop|cl}"
   exit 1
   ;;
esac
exit $?
